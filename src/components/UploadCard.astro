---
import UploadHeader from "./UploadHeader.astro";
import { RetentionToolbar } from "./islands/RetentionToolbar";
import { DropZone } from "./islands/DropZone";
import { FileList } from "./islands/FileList";
import { ActionsGrid } from "./islands/ActionsGrid";
import UploadFooter from "./UploadFooter.astro";
import { getRepoUrl } from "../lib/metadata";

interface UploadCardProps {
    id?: string;
    title?: string;
    subtitle?: string;
    footerCommit?: string;
    footerMessage?: string;
    footerRepoUrl?: string;
    footerLinks?: {
        label: string;
        href: string;
        external?: boolean;
        ariaLabel?: string;
    }[];
    retentionLabel?: string;
    retentionOptions?: string[];
    retentionDefaultIndex?: number;
    retentionValuePrefix?: string;
    dropPrimaryText?: string;
    dropSecondaryText?: string;
    dropMetaText?: string;
    dropAccept?: string;
    dropMultiple?: boolean;
    actions?: {
        id?: string;
        label: string;
        icon?: "files" | "report" | "more" | string;
        description?: string;
        ariaLabel?: string;
        disabled?: boolean;
    }[];
    autoScroll?: boolean;
    simulateUploads?: boolean;
    chunkRange?: [number, number];
}



const {
    id,
    title = "Juicebox",
    subtitle = "Click, Upload, Share!",
    footerCommit = "main@a3f8c2d",
    footerMessage = "juicebox2-epsilon",
    footerRepoUrl = getRepoUrl(),
    footerLinks = [],
    retentionLabel = "Retention",
    retentionOptions,
    retentionDefaultIndex,
    retentionValuePrefix = "",
    dropPrimaryText,
    dropSecondaryText,
    dropMetaText,
    dropAccept,
    dropMultiple = true,
    actions,
    autoScroll = false,
    simulateUploads = true,
    chunkRange = [40, 80],
} = Astro.props as UploadCardProps;

const cardId = id ?? `upload-card-${Math.random().toString(36).slice(2, 10)}`;
const retentionToolbarId = `${cardId}-retention`;
const dropZoneId = `${cardId}-drop-zone`;
const fileListId = `${cardId}-file-list`;
const actionsGridId = `${cardId}-actions`;
const headerId = `${cardId}-header`;
---

<div
    id={cardId}
    class="upload-card"
    data-upload-card
    data-component="upload-card"
    aria-labelledby={headerId}
>
    <UploadHeader id={headerId} title={title} subtitle={subtitle} />

    <RetentionToolbar
        client:load
        id={retentionToolbarId}
        label={retentionLabel}
        options={retentionOptions}
        defaultIndex={retentionDefaultIndex}
        valuePrefix={retentionValuePrefix}
    />

    <DropZone
        client:load
        id={dropZoneId}
        primaryText={dropPrimaryText}
        secondaryText={dropSecondaryText}
        metaText={dropMetaText}
        accept={dropAccept}
        multiple={dropMultiple}
    />

    <FileList
        client:load
        id={fileListId}
        autoScroll={autoScroll}
        simulateUploads={simulateUploads}
        chunkRange={chunkRange}
    />

    <ActionsGrid client:load id={actionsGridId} actions={actions} />

    <UploadFooter
        commit={footerCommit}
        message={footerMessage}
        repoUrl={footerRepoUrl}
        links={footerLinks}
    />
</div>

<script>
    import { navigate } from "astro:transitions/client";

    document.addEventListener("astro:page-load", () => {
        const card = document.querySelector("[data-upload-card]");
        if (!card) return;

        const retentionToolbar = card?.querySelector(
            "[data-retention-toolbar]",
        );
        const dropZone = card?.querySelector("[data-drop-zone]");
        const fileList = card?.querySelector("[data-file-list]");
        const actionsGrid = card?.querySelector("[data-actions-grid]");

        const emit = (type: string, detail: any) =>
            card.dispatchEvent(
                new CustomEvent(type, {
                    bubbles: true,
                    composed: true,
                    detail,
                }),
            );

        if (retentionToolbar) {
            retentionToolbar.addEventListener("retention-change", (event) => {
                emit(
                    "upload-retention-change",
                    (event as CustomEvent).detail ?? {},
                );
            });
        }

        if (dropZone) {
            dropZone.addEventListener("files-added", (event) => {
                emit(
                    "upload-files-added",
                    (event as CustomEvent).detail ?? { files: [] },
                );
            });
        }

        if (fileList) {
            fileList.addEventListener("file-added", (event) => {
                emit("upload-file-added", (event as CustomEvent).detail ?? {});
            });

            fileList.addEventListener("file-removed", (event) => {
                emit(
                    "upload-file-removed",
                    (event as CustomEvent).detail ?? {},
                );
            });

            fileList.addEventListener("file-completed", (event) => {
                emit(
                    "upload-file-completed",
                    (event as CustomEvent).detail ?? {},
                );
            });
        }

        if (actionsGrid) {
            actionsGrid.addEventListener("action-select", (event) => {
                const detail = (event as CustomEvent).detail ?? {};
                emit("upload-action-select", detail);

                // Handle navigation for Files action
                if (detail.id === "files") {
                    navigate("/files");
                }

                // Handle navigation for Report action
                if (detail.id === "report") {
                    navigate("/report");
                }
            });
        }

        card.addEventListener("upload-clear-files", () => {
            if (!fileList) return;
            fileList.dispatchEvent(
                new CustomEvent("clear-files", {
                    bubbles: true,
                    composed: true,
                }),
            );
        });

        card.addEventListener("upload-remove-file", (event) => {
            if (!fileList) return;
            fileList.dispatchEvent(
                new CustomEvent("remove-file", {
                    bubbles: true,
                    composed: true,
                    detail: (event as CustomEvent).detail ?? {},
                }),
            );
        });
    });
</script>
